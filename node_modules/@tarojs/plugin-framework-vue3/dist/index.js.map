{"version":3,"file":"index.js","sources":["../src/loader-meta.ts","../src/webpack.mini.ts","../src/webpack.h5.ts","../src/index.ts"],"sourcesContent":["interface ILoaderMeta {\n  importFrameworkStatement: string\n  mockAppStatement: string\n  frameworkArgs: string\n  creator: string\n  creatorLocation: string\n  importFrameworkName: string\n  isNeedRawLoader?: boolean\n  extraImportForWeb?: string\n  execBeforeCreateWebApp?: string\n  compatComponentImport?: string\n  compatComponentExtra?: string\n  modifyConfig?: (config: Record<string, any>, source: string) => void\n}\n\nexport function getLoaderMeta (): ILoaderMeta {\n  return {\n    importFrameworkStatement: `\nimport { h, createApp } from 'vue'\n`,\n    mockAppStatement: `\nconst App = createApp({})\n`,\n    frameworkArgs: 'h, config',\n    creator: 'createVue3App',\n    creatorLocation: '@tarojs/plugin-framework-vue3/dist/runtime',\n    importFrameworkName: 'h',\n    isNeedRawLoader: true,\n    extraImportForWeb: `\nimport { initVue3Components } from '@tarojs/components/dist-h5/vue3'\n`,\n    execBeforeCreateWebApp: `\ninitVue3Components(component)\n`\n  }\n}\n","import { REG_VUE } from '@tarojs/helper'\nimport { internalComponents, toCamelCase, capitalize } from '@tarojs/shared/dist/template'\nimport { getLoaderMeta } from './loader-meta'\nimport { getVueLoaderPath } from './index'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { RootNode, TemplateChildNode, ElementNode, AttributeNode, DirectiveNode, SimpleExpressionNode } from '@vue/compiler-core'\nimport type { IConfig } from './index'\n\nconst CUSTOM_WRAPPER = 'custom-wrapper'\n\ntype MiniConfig = IConfig['mini']\n\nexport function modifyMiniWebpackChain (_ctx: IPluginContext, chain, data, config: MiniConfig) {\n  setVueLoader(chain, data, config)\n  setLoader(chain)\n  setDefinePlugin(chain)\n}\n\nfunction setVueLoader (chain, data, config: MiniConfig) {\n  const vueLoaderPath = getVueLoaderPath()\n\n  // plugin\n  const { VueLoaderPlugin } = require(vueLoaderPath)\n  chain\n    .plugin('vueLoaderPlugin')\n    .use(VueLoaderPlugin)\n\n  // loader\n  const vueLoaderOption: any = {\n    optimizeSSR: false,\n    transformAssetUrls: {\n      video: ['src', 'poster'],\n      'live-player': 'src',\n      audio: 'src',\n      source: 'src',\n      image: 'src',\n      'cover-image': 'src'\n    },\n    compilerOptions: {}\n  }\n\n  if (config?.compilerOptions) {\n    vueLoaderOption.compilerOptions = Object.assign({}, config.compilerOptions)\n  }\n\n  vueLoaderOption.compilerOptions.nodeTransforms ||= []\n  vueLoaderOption.compilerOptions.nodeTransforms.unshift((node: RootNode | TemplateChildNode) => {\n    if (node.type === 1 /* ELEMENT */) {\n      node = node as ElementNode\n      const nodeName = node.tag\n\n      if (capitalize(toCamelCase(nodeName)) in internalComponents) {\n        // change only ElementTypes.COMPONENT to ElementTypes.ELEMENT\n        // and leave ElementTypes.SLOT untouched\n        if (node.tagType === 1 /* COMPONENT */) {\n          node.tagType = 0 /* ELEMENT */\n        }\n        data.componentConfig.includes.add(nodeName)\n      }\n\n      if (nodeName === CUSTOM_WRAPPER) {\n        node.tagType = 0 /* ELEMENT */\n        data.componentConfig.thirdPartyComponents.set(CUSTOM_WRAPPER, new Set())\n      }\n\n      const usingComponent = data.componentConfig.thirdPartyComponents.get(nodeName)\n      if (usingComponent != null) {\n        node.props.forEach(prop => {\n          if (prop.type === 6 /* ATTRIBUTE */) {\n            usingComponent.add((prop as AttributeNode).name)\n          } else if ((prop as any).type === 7 /* DIRECTIVE */) {\n            prop = prop as DirectiveNode\n            if (prop.arg?.type === 4 /* SimpleExpression */) {\n              let value = (prop.arg as SimpleExpressionNode).content\n              if (prop.name === 'on') {\n                value = `on${value}`\n              }\n              usingComponent.add(value)\n            }\n          }\n        })\n      }\n    }\n  })\n\n  chain.module\n    .rule('vue')\n    .test(REG_VUE)\n    .use('vueLoader')\n    .loader(vueLoaderPath)\n    .options(vueLoaderOption)\n}\n\nfunction setLoader (chain) {\n  chain.plugin('miniPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta()\n      return args\n    })\n}\n\nfunction setDefinePlugin (chain) {\n  chain\n    .plugin('definePlugin')\n    .tap(args => {\n      args[0].ENABLE_ADJACENT_HTML = true\n      args[0].ENABLE_CLONE_NODE = true\n      args[0].ENABLE_TEMPLATE_CONTENT = true\n      args[0].ENABLE_MUTATION_OBSERVER = true\n      return args\n    })\n}\n","import { REG_VUE } from '@tarojs/helper'\nimport { DEFAULT_Components } from '@tarojs/runner-utils'\nimport { getLoaderMeta } from './loader-meta'\nimport { getVueLoaderPath } from './index'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { RootNode, TemplateChildNode, ElementNode } from '@vue/compiler-core'\n\nexport function modifyH5WebpackChain (ctx: IPluginContext, chain) {\n  setStyleLoader(ctx, chain)\n  setVueLoader(chain)\n  setLoader(chain)\n  setTaroApiLoader(chain)\n}\n\nfunction setStyleLoader (ctx: IPluginContext, chain) {\n  const config = ctx.initialConfig.h5 || {}\n\n  const { styleLoaderOption = {} } = config\n  chain.module\n    .rule('customStyle')\n    .merge({\n      use: [{\n        loader: 'style-loader',\n        options: styleLoaderOption\n      }]\n    })\n}\n\nfunction setVueLoader (chain) {\n  const vueLoaderPath = getVueLoaderPath()\n\n  // plugin\n  const { VueLoaderPlugin } = require(vueLoaderPath)\n  chain\n    .plugin('vueLoaderPlugin')\n    .use(VueLoaderPlugin)\n\n  // loader\n  const vueLoaderOption = {\n    transformAssetUrls: {\n      video: ['src', 'poster'],\n      'live-player': 'src',\n      audio: 'src',\n      source: 'src',\n      image: 'src',\n      'cover-image': 'src',\n      'taro-video': ['src', 'poster'],\n      'taro-live-player': 'src',\n      'taro-audio': 'src',\n      'taro-source': 'src',\n      'taro-image': 'src',\n      'taro-cover-image': 'src'\n    },\n    compilerOptions: {\n      // https://github.com/vuejs/vue-next/blob/master/packages/compiler-core/src/options.ts\n      nodeTransforms: [(node: RootNode | TemplateChildNode) => {\n        if (node.type === 1 /* ELEMENT */) {\n          node = node as ElementNode\n          const nodeName = node.tag\n          if (DEFAULT_Components.has(nodeName)) {\n            node.tag = `taro-${nodeName}`\n            node.tagType = 1 /* 0: ELEMENT, 1: COMPONENT */\n          }\n        }\n      }]\n    }\n  }\n\n  chain.module\n    .rule('vue')\n    .test(REG_VUE)\n    .use('vueLoader')\n    .loader(vueLoaderPath)\n    .options(vueLoaderOption)\n}\n\nfunction setLoader (chain) {\n  chain.plugin('mainPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta()\n      return args\n    })\n}\n\nfunction setTaroApiLoader (chain) {\n  chain.merge({\n    module: {\n      rule: {\n        'process-import-taro': {\n          test: /taro-h5[\\\\/]dist[\\\\/]index/,\n          loader: require.resolve('./api-loader')\n        }\n      }\n    }\n  })\n}\n","import { chalk } from '@tarojs/helper'\nimport { modifyMiniWebpackChain } from './webpack.mini'\nimport { modifyH5WebpackChain } from './webpack.h5'\n\nimport type { IPluginContext } from '@tarojs/service'\n\nexport interface IConfig {\n  mini?: {\n    compilerOptions: {\n      isCustomElement: (tag: string) => boolean\n      whitespace: 'condense' | 'preserve'\n      delimiters: string[]\n      comments: boolean\n      nodeTransforms: ((...args: any) => void)[]\n    }\n  }\n}\n\nexport default (ctx: IPluginContext, config: IConfig = {}) => {\n  const { framework } = ctx.initialConfig\n  if (framework !== 'vue3') return\n\n  ctx.modifyWebpackChain(({ chain, webpack, data }) => {\n    // 通用\n    // setAlias(chain)\n    setDefinePlugin(chain, webpack)\n\n    if (process.env.TARO_ENV === 'h5') {\n      // H5\n      modifyH5WebpackChain(ctx, chain)\n    } else {\n      // 小程序\n      modifyMiniWebpackChain(ctx, chain, data, config.mini)\n    }\n  })\n}\n\n// function setAlias (chain) {\n//   // 避免 npm link 时，taro composition apis 使用的 vue 和项目使用的 vue 实例不一致。\n//   chain.resolve.alias\n//     .set('vue', require.resolve('vue'))\n// }\n\nfunction setDefinePlugin (chain, webpack) {\n  chain\n    .plugin('defined')\n    .use(webpack.DefinePlugin, [{\n      __VUE_OPTIONS_API__: JSON.stringify(true),\n      __VUE_PROD_DEVTOOLS__: JSON.stringify(false)\n    }])\n}\n\nexport function getVueLoaderPath (): string {\n  try {\n    return require.resolve('vue-loader', {\n      paths: [process.cwd()]\n    })\n  } catch (error) {\n    // eslint-disable-next-line no-console\n    console.log(chalk.yellow('找不到 vue-loader，请先安装。'))\n    process.exit(1)\n  }\n}\n"],"names":["setVueLoader","setLoader","setDefinePlugin","capitalize","toCamelCase","internalComponents","REG_VUE","DEFAULT_Components","chalk"],"mappings":"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"}