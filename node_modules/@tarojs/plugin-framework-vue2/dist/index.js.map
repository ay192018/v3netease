{"version":3,"file":"index.js","sources":["../src/loader-meta.ts","../src/index.ts"],"sourcesContent":["interface ILoaderMeta {\n  importFrameworkStatement: string\n  mockAppStatement: string\n  frameworkArgs: string\n  creator: string\n  creatorLocation: string\n  importFrameworkName: string\n  isNeedRawLoader?: boolean\n  extraImportForWeb?: string\n  execBeforeCreateWebApp?: string\n  compatComponentImport?: string\n  compatComponentExtra?: string\n  modifyConfig?: (config: Record<string, any>, source: string) => void\n}\n\nexport function getLoaderMeta (): ILoaderMeta {\n  return {\n    importFrameworkStatement: `\nimport Vue from 'vue';\n`,\n    mockAppStatement: `\nconst App = {\n  render (h) {\n    // this.$slots.default 是将要会渲染的页面\n    return h('block', this.$slots.default)\n  }\n}\n`,\n    frameworkArgs: 'Vue, config',\n    creator: 'createVueApp',\n    creatorLocation: '@tarojs/plugin-framework-vue2/dist/runtime',\n    importFrameworkName: 'Vue',\n    isNeedRawLoader: true,\n    extraImportForWeb: `\nrequire('@tarojs/components/dist-h5/vue')\n`\n  }\n}\n","import { REG_VUE, chalk } from '@tarojs/helper'\nimport { DEFAULT_Components } from '@tarojs/runner-utils'\nimport { internalComponents, toCamelCase, capitalize } from '@tarojs/shared/dist/template'\nimport { getLoaderMeta } from './loader-meta'\n\nimport type { IPluginContext } from '@tarojs/service'\n\nconst CUSTOM_WRAPPER = 'custom-wrapper'\nlet isBuildH5\n\nexport default (ctx: IPluginContext) => {\n  const { framework } = ctx.initialConfig\n  if (framework !== 'vue') return\n\n  isBuildH5 = process.env.TARO_ENV === 'h5'\n\n  ctx.modifyWebpackChain(({ chain, data }) => {\n    customVueChain(chain, data)\n    setLoader(chain)\n\n    if (isBuildH5) {\n      setStyleLoader(ctx, chain)\n    }\n  })\n}\n\nfunction getVueLoaderPath (): string {\n  try {\n    return require.resolve('vue-loader', {\n      paths: [process.cwd()]\n    })\n  } catch (error) {\n    // eslint-disable-next-line no-console\n    console.log(chalk.yellow('找不到 vue-loader，请先安装。'))\n    process.exit(1)\n  }\n}\n\nfunction customVueChain (chain, data) {\n  const vueLoaderPath = getVueLoaderPath()\n\n  // plugin\n  const { VueLoaderPlugin } = require(vueLoaderPath)\n  chain\n    .plugin('vueLoaderPlugin')\n    .use(VueLoaderPlugin)\n\n  // loader\n  let vueLoaderOption\n\n  if (isBuildH5) {\n    // H5\n    vueLoaderOption = {\n      transformAssetUrls: {\n        video: ['src', 'poster'],\n        'live-player': 'src',\n        audio: 'src',\n        source: 'src',\n        image: 'src',\n        'cover-image': 'src',\n        'taro-video': ['src', 'poster'],\n        'taro-live-player': 'src',\n        'taro-audio': 'src',\n        'taro-source': 'src',\n        'taro-image': 'src',\n        'taro-cover-image': 'src'\n      },\n      compilerOptions: {\n        modules: [{\n          preTransformNode (el) {\n            if (DEFAULT_Components.has(el.tag)) {\n              el.tag = 'taro-' + el.tag\n            }\n            return el\n          }\n        }]\n      }\n    }\n  } else {\n    // 小程序\n    vueLoaderOption = {\n      optimizeSSR: false,\n      transformAssetUrls: {\n        video: ['src', 'poster'],\n        'live-player': 'src',\n        audio: 'src',\n        source: 'src',\n        image: 'src',\n        'cover-image': 'src'\n      },\n      compilerOptions: {\n        whitespace: 'condense',\n        modules: [{\n          preTransformNode (el) {\n            const nodeName = el.tag\n            if (capitalize(toCamelCase(nodeName)) in internalComponents) {\n              data.componentConfig.includes.add(nodeName)\n            }\n\n            if (nodeName === CUSTOM_WRAPPER) {\n              data.componentConfig.thirdPartyComponents.set(CUSTOM_WRAPPER, new Set())\n            }\n\n            const usingComponent = data.componentConfig.thirdPartyComponents.get(nodeName)\n            if (usingComponent != null) {\n              el.attrsList\n                .filter(a => !a.dynamic)\n                .forEach(a => usingComponent.add(a.name.startsWith(':') ? a.name.slice(1) : a.name))\n            }\n\n            return el\n          }\n        }],\n        mustUseProp: function () {\n          return false\n        }\n      }\n    }\n  }\n\n  chain.module\n    .rule('vue')\n    .test(REG_VUE)\n    .use('vueLoader')\n    .loader(vueLoaderPath)\n    .options(vueLoaderOption)\n}\n\nfunction setStyleLoader (ctx: IPluginContext, chain) {\n  const config = ctx.initialConfig.h5 || {}\n\n  const { styleLoaderOption = {} } = config\n  chain.module\n    .rule('customStyle')\n    .merge({\n      use: [{\n        loader: 'style-loader',\n        options: styleLoaderOption\n      }]\n    })\n}\n\nfunction setLoader (chain) {\n  if (isBuildH5) {\n    chain.plugin('mainPlugin')\n      .tap(args => {\n        args[0].loaderMeta = getLoaderMeta()\n        return args\n      })\n  } else {\n    chain.plugin('miniPlugin')\n      .tap(args => {\n        args[0].loaderMeta = getLoaderMeta()\n        return args\n      })\n  }\n}\n"],"names":["chalk","DEFAULT_Components","capitalize","toCamelCase","internalComponents","REG_VUE"],"mappings":"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"}