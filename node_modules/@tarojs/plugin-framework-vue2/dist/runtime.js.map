{"version":3,"file":"runtime.js","sources":["../src/runtime/utils.ts","../src/runtime/connect.ts"],"sourcesContent":["import { Current } from '@tarojs/runtime'\n\n/**\n * set writable, enumerable to true\n */\nexport function setDefaultDescriptor (obj: Record<string, any>) {\n  obj.writable = true\n  obj.enumerable = true\n  return obj\n}\n\n/**\n * 设置入口的路由参数\n * @param options 小程序传入的参数\n */\nexport function setRouterParams (options) {\n  Current.router = {\n    params: options?.query,\n    ...options\n  }\n}\n","import { isFunction, noop, ensure, isBoolean } from '@tarojs/shared'\nimport {\n  container,\n  SERVICE_IDENTIFIER,\n  Current,\n  document,\n  injectPageInstance\n} from '@tarojs/runtime'\nimport { setDefaultDescriptor, setRouterParams } from './utils'\n\n/* eslint-disable import/no-duplicates */\nimport type VueCtor from 'vue'\nimport type { ComponentOptions, VueConstructor, VNode } from 'vue'\nimport type { AppConfig } from '@tarojs/taro'\nimport type { IHooks, AppInstance, VueAppInstance, VueInstance } from '@tarojs/runtime'\n\nexport type V = typeof VueCtor\n\nlet Vue\n\nfunction setReconciler () {\n  const hooks = container.get<IHooks>(SERVICE_IDENTIFIER.Hooks)\n\n  hooks.onRemoveAttribute = function (dom, qualifiedName) {\n    // 处理原因: https://github.com/NervJS/taro/pull/5990\n    const props = dom.props\n    if (!props.hasOwnProperty(qualifiedName) || isBoolean(props[qualifiedName])) {\n      dom.setAttribute(qualifiedName, false)\n      return true\n    }\n  }\n\n  hooks.getLifecycle = function (instance, lifecycle) {\n    return instance.$options[lifecycle]\n  }\n\n  if (process.env.TARO_ENV === 'h5') {\n    hooks.createPullDownComponent = (el, path, vue: VueConstructor) => {\n      const injectedPage = vue.extend({\n        props: {\n          tid: String\n        },\n        mixins: [el as ComponentOptions<Vue>, {\n          created () {\n            injectPageInstance(this, path)\n          }\n        }]\n      })\n\n      const options: ComponentOptions<Vue> = {\n        name: 'PullToRefresh',\n        render (h) {\n          return h(\n            'taro-pull-to-refresh',\n            {\n              class: ['hydrated']\n            },\n            [h(injectedPage, this.$slots.default)]\n          )\n        }\n      }\n\n      return options\n    }\n\n    hooks.getDOMNode = (el) => {\n      return el.$el as any\n    }\n  }\n}\n\nexport function connectVuePage (Vue: VueConstructor, id: string) {\n  return (component: ComponentOptions<VueCtor>) => {\n    const injectedPage = Vue.extend({\n      props: {\n        tid: String\n      },\n      mixins: [component, {\n        created () {\n          injectPageInstance(this, id)\n        }\n      }]\n    })\n\n    const options: ComponentOptions<VueCtor> = {\n      render (h) {\n        return h(\n          process.env.TARO_ENV === 'h5' ? 'div' : 'root',\n          {\n            attrs: {\n              id,\n              class: process.env.TARO_ENV === 'h5' ? 'taro_page' : ''\n            }\n          },\n          [\n            h(injectedPage, { props: { tid: id } })\n          ]\n        )\n      }\n    }\n\n    return options\n  }\n}\n\nexport function createVueApp (App: ComponentOptions<VueCtor>, vue: V, config: AppConfig) {\n  if (process.env.NODE_ENV !== 'production') {\n    ensure(!!vue, '构建 Vue 项目请把 process.env.FRAMEWORK 设置为 \\'vue\\'')\n  }\n\n  Vue = vue\n  Vue.config.getTagNamespace = noop\n  const elements: VNode[] = []\n  const pages: Array<(h: Vue.CreateElement) => VNode> = []\n  let appInstance: VueAppInstance\n\n  setReconciler()\n\n  const wrapper = new (Vue as VueConstructor)({\n    render (h) {\n      while (pages.length > 0) {\n        const page = pages.pop()!\n        elements.push(page(h))\n      }\n      return h(App, { ref: 'app' }, elements.slice())\n    },\n    methods: {\n      mount (component: ComponentOptions<VueCtor>, id: string, cb: () => void) {\n        pages.push((h) => h(component, { key: id }))\n        this.updateSync(cb)\n      },\n      updateSync (this: VueInstance, cb: () => void) {\n        this._update(this._render(), false)\n        this.$children.forEach((child: VueInstance) => child._update(child._render(), false))\n        cb()\n      },\n      unmount (id: string, cb: () => void) {\n        for (let i = 0; i < elements.length; i++) {\n          const element = elements[i]\n          if (element.key === id) {\n            elements.splice(i, 1)\n            break\n          }\n        }\n\n        this.updateSync(cb)\n      }\n    }\n  })\n\n  if (process.env.TARO_ENV !== 'h5') {\n    wrapper.$mount(document.getElementById('app') as any)\n  }\n\n  const hooks = container.get<IHooks>(SERVICE_IDENTIFIER.Hooks)\n  const [ONLAUNCH, ONSHOW, ONHIDE] = hooks.getMiniLifecycleImpl().app\n\n  const appObj: AppInstance = Object.create({\n    mount (component: ComponentOptions<VueCtor>, id: string, cb: () => void) {\n      const page = connectVuePage(Vue, id)(component)\n      wrapper.mount(page, id, cb)\n    },\n\n    unmount (id: string, cb: () => void) {\n      wrapper.unmount(id, cb)\n    }\n  }, {\n    config: setDefaultDescriptor({\n      configurable: true,\n      value: config\n    }),\n\n    [ONLAUNCH]: setDefaultDescriptor({\n      value (options) {\n        setRouterParams(options)\n\n        if (process.env.TARO_ENV === 'h5') {\n          // 由于 H5 路由初始化的时候会清除 app 下的 dom 元素，所以需要在路由初始化后再执行 render\n          wrapper.$mount(document.getElementById(config?.appId || 'app') as any)\n        }\n\n        appInstance = wrapper.$refs.app as VueAppInstance\n        if (appInstance != null && isFunction(appInstance.$options.onLaunch)) {\n          appInstance.$options.onLaunch.call(appInstance, options)\n        }\n      }\n    }),\n\n    [ONSHOW]: setDefaultDescriptor({\n      value (options) {\n        setRouterParams(options)\n\n        if (appInstance != null && isFunction(appInstance.$options.onShow)) {\n          appInstance.$options.onShow.call(appInstance, options)\n        }\n      }\n    }),\n\n    [ONHIDE]: setDefaultDescriptor({\n      value (options) {\n        if (appInstance != null && isFunction(appInstance.$options.onHide)) {\n          appInstance.$options.onHide.call(appInstance, options)\n        }\n      }\n    })\n  })\n\n  Current.app = appObj\n\n  return appObj\n}\n"],"names":[],"mappings":";;;AAEA;;;SAGgB,oBAAoB,CAAE,GAAwB;IAC5D,GAAG,CAAC,QAAQ,GAAG,IAAI,CAAA;IACnB,GAAG,CAAC,UAAU,GAAG,IAAI,CAAA;IACrB,OAAO,GAAG,CAAA;AACZ,CAAC;AAED;;;;SAIgB,eAAe,CAAE,OAAO;IACtC,OAAO,CAAC,MAAM,mBACZ,MAAM,EAAE,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,KAAK,IACnB,OAAO,CACX,CAAA;AACH;;ACFA,IAAI,GAAG,CAAA;AAEP,SAAS,aAAa;IACpB,MAAM,KAAK,GAAG,SAAS,CAAC,GAAG,CAAS,kBAAkB,CAAC,KAAK,CAAC,CAAA;IAE7D,KAAK,CAAC,iBAAiB,GAAG,UAAU,GAAG,EAAE,aAAa;;QAEpD,MAAM,KAAK,GAAG,GAAG,CAAC,KAAK,CAAA;QACvB,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,aAAa,CAAC,IAAI,SAAS,CAAC,KAAK,CAAC,aAAa,CAAC,CAAC,EAAE;YAC3E,GAAG,CAAC,YAAY,CAAC,aAAa,EAAE,KAAK,CAAC,CAAA;YACtC,OAAO,IAAI,CAAA;SACZ;KACF,CAAA;IAED,KAAK,CAAC,YAAY,GAAG,UAAU,QAAQ,EAAE,SAAS;QAChD,OAAO,QAAQ,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAA;KACpC,CAAA;IAED,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,IAAI,EAAE;QACjC,KAAK,CAAC,uBAAuB,GAAG,CAAC,EAAE,EAAE,IAAI,EAAE,GAAmB;YAC5D,MAAM,YAAY,GAAG,GAAG,CAAC,MAAM,CAAC;gBAC9B,KAAK,EAAE;oBACL,GAAG,EAAE,MAAM;iBACZ;gBACD,MAAM,EAAE,CAAC,EAA2B,EAAE;wBACpC,OAAO;4BACL,kBAAkB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;yBAC/B;qBACF,CAAC;aACH,CAAC,CAAA;YAEF,MAAM,OAAO,GAA0B;gBACrC,IAAI,EAAE,eAAe;gBACrB,MAAM,CAAE,CAAC;oBACP,OAAO,CAAC,CACN,sBAAsB,EACtB;wBACE,KAAK,EAAE,CAAC,UAAU,CAAC;qBACpB,EACD,CAAC,CAAC,CAAC,YAAY,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CACvC,CAAA;iBACF;aACF,CAAA;YAED,OAAO,OAAO,CAAA;SACf,CAAA;QAED,KAAK,CAAC,UAAU,GAAG,CAAC,EAAE;YACpB,OAAO,EAAE,CAAC,GAAU,CAAA;SACrB,CAAA;KACF;AACH,CAAC;SAEe,cAAc,CAAE,GAAmB,EAAE,EAAU;IAC7D,OAAO,CAAC,SAAoC;QAC1C,MAAM,YAAY,GAAG,GAAG,CAAC,MAAM,CAAC;YAC9B,KAAK,EAAE;gBACL,GAAG,EAAE,MAAM;aACZ;YACD,MAAM,EAAE,CAAC,SAAS,EAAE;oBAClB,OAAO;wBACL,kBAAkB,CAAC,IAAI,EAAE,EAAE,CAAC,CAAA;qBAC7B;iBACF,CAAC;SACH,CAAC,CAAA;QAEF,MAAM,OAAO,GAA8B;YACzC,MAAM,CAAE,CAAC;gBACP,OAAO,CAAC,CACN,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,IAAI,GAAG,KAAK,GAAG,MAAM,EAC9C;oBACE,KAAK,EAAE;wBACL,EAAE;wBACF,KAAK,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,IAAI,GAAG,WAAW,GAAG,EAAE;qBACxD;iBACF,EACD;oBACE,CAAC,CAAC,YAAY,EAAE,EAAE,KAAK,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,CAAC;iBACxC,CACF,CAAA;aACF;SACF,CAAA;QAED,OAAO,OAAO,CAAA;KACf,CAAA;AACH,CAAC;SAEe,YAAY,CAAE,GAA8B,EAAE,GAAM,EAAE,MAAiB;IACrF,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY,EAAE;QACzC,MAAM,CAAC,CAAC,CAAC,GAAG,EAAE,+CAA+C,CAAC,CAAA;KAC/D;IAED,GAAG,GAAG,GAAG,CAAA;IACT,GAAG,CAAC,MAAM,CAAC,eAAe,GAAG,IAAI,CAAA;IACjC,MAAM,QAAQ,GAAY,EAAE,CAAA;IAC5B,MAAM,KAAK,GAA2C,EAAE,CAAA;IACxD,IAAI,WAA2B,CAAA;IAE/B,aAAa,EAAE,CAAA;IAEf,MAAM,OAAO,GAAG,IAAK,GAAsB,CAAC;QAC1C,MAAM,CAAE,CAAC;YACP,OAAO,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;gBACvB,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,EAAG,CAAA;gBACzB,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAA;aACvB;YACD,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,EAAE,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAA;SAChD;QACD,OAAO,EAAE;YACP,KAAK,CAAE,SAAoC,EAAE,EAAU,EAAE,EAAc;gBACrE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,SAAS,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC,CAAA;gBAC5C,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC,CAAA;aACpB;YACD,UAAU,CAAqB,EAAc;gBAC3C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,CAAA;gBACnC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,KAAkB,KAAK,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,CAAC,CAAA;gBACrF,EAAE,EAAE,CAAA;aACL;YACD,OAAO,CAAE,EAAU,EAAE,EAAc;gBACjC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;oBACxC,MAAM,OAAO,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAA;oBAC3B,IAAI,OAAO,CAAC,GAAG,KAAK,EAAE,EAAE;wBACtB,QAAQ,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAA;wBACrB,MAAK;qBACN;iBACF;gBAED,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC,CAAA;aACpB;SACF;KACF,CAAC,CAAA;IAEF,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,IAAI,EAAE;QACjC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,cAAc,CAAC,KAAK,CAAQ,CAAC,CAAA;KACtD;IAED,MAAM,KAAK,GAAG,SAAS,CAAC,GAAG,CAAS,kBAAkB,CAAC,KAAK,CAAC,CAAA;IAC7D,MAAM,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC,GAAG,KAAK,CAAC,oBAAoB,EAAE,CAAC,GAAG,CAAA;IAEnE,MAAM,MAAM,GAAgB,MAAM,CAAC,MAAM,CAAC;QACxC,KAAK,CAAE,SAAoC,EAAE,EAAU,EAAE,EAAc;YACrE,MAAM,IAAI,GAAG,cAAc,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,SAAS,CAAC,CAAA;YAC/C,OAAO,CAAC,KAAK,CAAC,IAAI,EAAE,EAAE,EAAE,EAAE,CAAC,CAAA;SAC5B;QAED,OAAO,CAAE,EAAU,EAAE,EAAc;YACjC,OAAO,CAAC,OAAO,CAAC,EAAE,EAAE,EAAE,CAAC,CAAA;SACxB;KACF,EAAE;QACD,MAAM,EAAE,oBAAoB,CAAC;YAC3B,YAAY,EAAE,IAAI;YAClB,KAAK,EAAE,MAAM;SACd,CAAC;QAEF,CAAC,QAAQ,GAAG,oBAAoB,CAAC;YAC/B,KAAK,CAAE,OAAO;gBACZ,eAAe,CAAC,OAAO,CAAC,CAAA;gBAExB,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,IAAI,EAAE;;oBAEjC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,KAAK,KAAI,KAAK,CAAQ,CAAC,CAAA;iBACvE;gBAED,WAAW,GAAG,OAAO,CAAC,KAAK,CAAC,GAAqB,CAAA;gBACjD,IAAI,WAAW,IAAI,IAAI,IAAI,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE;oBACpE,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,CAAA;iBACzD;aACF;SACF,CAAC;QAEF,CAAC,MAAM,GAAG,oBAAoB,CAAC;YAC7B,KAAK,CAAE,OAAO;gBACZ,eAAe,CAAC,OAAO,CAAC,CAAA;gBAExB,IAAI,WAAW,IAAI,IAAI,IAAI,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;oBAClE,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,CAAA;iBACvD;aACF;SACF,CAAC;QAEF,CAAC,MAAM,GAAG,oBAAoB,CAAC;YAC7B,KAAK,CAAE,OAAO;gBACZ,IAAI,WAAW,IAAI,IAAI,IAAI,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;oBAClE,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,CAAA;iBACvD;aACF;SACF,CAAC;KACH,CAAC,CAAA;IAEF,OAAO,CAAC,GAAG,GAAG,MAAM,CAAA;IAEpB,OAAO,MAAM,CAAA;AACf;;;;"}