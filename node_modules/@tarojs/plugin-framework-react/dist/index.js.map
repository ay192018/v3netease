{"version":3,"file":"index.js","sources":["../src/loader-meta.ts","../src/webpack.mini.ts","../src/webpack.h5.ts","../src/index.ts"],"sourcesContent":["import * as acorn from 'acorn'\nimport * as walk from 'acorn-walk'\nimport { Frameworks } from './index'\n\ninterface ILoaderMeta {\n  importFrameworkStatement: string\n  mockAppStatement: string\n  frameworkArgs: string\n  creator: string\n  creatorLocation: string\n  importFrameworkName: string\n  isNeedRawLoader?: boolean\n  extraImportForWeb?: string\n  execBeforeCreateWebApp?: string\n  compatComponentImport?: string\n  compatComponentExtra?: string\n  modifyConfig?: (config: Record<string, any>, source: string) => void\n}\n\nfunction addConfig (source) {\n  const configsMap = {\n    enableShareAppMessage: ['onShareAppMessage', 'useShareAppMessage'],\n    enableShareTimeline: ['onShareTimeline', 'useShareTimeline']\n  }\n  const ast = acorn.parse(source, {\n    ecmaVersion: 'latest',\n    sourceType: 'module'\n  })\n\n  const additionConfig: Record<string, any> = {}\n\n  function check (name: string) {\n    Object.keys(configsMap).forEach(configName => {\n      const apis: string[] = configsMap[configName]\n      if (apis.includes(name)) {\n        additionConfig[configName] = true\n      }\n    })\n  }\n\n  walk.simple(ast, {\n    FunctionExpression (node: any) {\n      if (!node.id || !node.id.name) return\n      check(node.id.name)\n    },\n    FunctionDeclaration (node: any) {\n      if (!node.id || !node.id.name) return\n      check(node.id.name)\n    },\n    CallExpression (node: any) {\n      const { callee } = node\n      if (callee.type === 'Identifier') {\n        check(callee.name)\n      } else if (callee.type === 'MemberExpression') {\n        if (callee.property.type === 'Identifier') {\n          check(callee.property.name)\n        } else if (callee.property.type === 'Literal') {\n          check(callee.property.value)\n        }\n      }\n    }\n  })\n\n  return additionConfig\n}\n\nconst frameworkMeta: Record<string, ILoaderMeta> = {\n  nerv: {\n    importFrameworkStatement: `\nimport Nerv from 'nervjs';\n`,\n    mockAppStatement: `\nclass App extends Nerv.Component {\n  render () {\n    return this.props.children\n  }\n}\n`,\n    frameworkArgs: 'Nerv, Nerv, config',\n    creator: 'createReactApp',\n    creatorLocation: '@tarojs/plugin-framework-react/dist/runtime',\n    importFrameworkName: 'Nerv',\n    modifyConfig (config, source) {\n      Object.assign(config, addConfig(source))\n    }\n  },\n  react: {\n    importFrameworkStatement: `\nimport * as React from 'react'\nimport ReactDOM from 'react-dom'\n`,\n    mockAppStatement: `\nclass App extends React.Component {\n  render () {\n    return this.props.children\n  }\n}\n`,\n    frameworkArgs: 'React, ReactDOM, config',\n    creator: 'createReactApp',\n    creatorLocation: '@tarojs/plugin-framework-react/dist/runtime',\n    importFrameworkName: 'React',\n    compatComponentImport: 'import { PullDownRefresh } from \"@tarojs/components\"',\n    compatComponentExtra: 'config.PullDownRefresh = PullDownRefresh',\n    modifyConfig (config, source) {\n      Object.assign(config, addConfig(source))\n    }\n  }\n}\n\nexport function getLoaderMeta (framework: Frameworks) {\n  if (framework === 'preact') framework = 'react'\n  return frameworkMeta[framework]\n}\n","\nimport { getLoaderMeta } from './loader-meta'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { Frameworks } from './index'\n\nexport function modifyMiniWebpackChain (ctx: IPluginContext, framework: Frameworks, chain) {\n  setAlias(ctx, framework, chain)\n  setLoader(framework, chain)\n}\n\nfunction setAlias (ctx: IPluginContext, framework: Frameworks, chain) {\n  const config = ctx.initialConfig\n  const alias = chain.resolve.alias\n\n  if (framework === 'react') {\n    alias.set('react-dom$', '@tarojs/react')\n    if (process.env.NODE_ENV !== 'production' && config.mini?.debugReact !== true) {\n      // 不是生产环境，且没有设置 debugReact，则使用压缩版本的 react 依赖，减少体积\n      alias.set('react-reconciler$', 'react-reconciler/cjs/react-reconciler.production.min.js')\n      alias.set('react$', 'react/cjs/react.production.min.js')\n      alias.set('scheduler$', 'scheduler/cjs/scheduler.production.min.js')\n      alias.set('react/jsx-runtime$', 'react/cjs/react-jsx-runtime.production.min.js')\n    }\n  }\n}\n\nfunction setLoader (framework: Frameworks, chain) {\n  chain.plugin('miniPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta(framework)\n      return args\n    })\n}\n","\nimport { getLoaderMeta } from './loader-meta'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { Frameworks } from './index'\n\nexport function modifyH5WebpackChain (ctx: IPluginContext, framework: Frameworks, chain) {\n  setAlias(ctx, chain)\n  setLoader(framework, chain)\n  setPlugin(ctx, framework, chain)\n\n  chain.merge({\n    module: {\n      rule: {\n        'process-import-taro': {\n          test: /taro-h5[\\\\/]dist[\\\\/]index/,\n          loader: require.resolve('./api-loader')\n        }\n      }\n    }\n  })\n}\n\nfunction setAlias (ctx: IPluginContext, chain) {\n  const config = ctx.initialConfig\n  const alias = chain.resolve.alias\n\n  if (config.h5?.useHtmlComponents) {\n    alias.set('@tarojs/components$', '@tarojs/components-react/index')\n  } else {\n    alias.set('@tarojs/components$', '@tarojs/components/dist-h5/react')\n  }\n}\n\nfunction setLoader (framework: Frameworks, chain) {\n  chain.plugin('mainPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta(framework)\n      return args\n    })\n}\n\nfunction setPlugin (ctx: IPluginContext, framework: Frameworks, chain) {\n  const config = ctx.initialConfig\n\n  if (\n    process.env.NODE_ENV !== 'production' &&\n    config.h5?.devServer?.hot !== false\n  ) {\n    // 默认开启 fast-refresh\n    if (framework === 'react') {\n      chain\n        .plugin('fastRefreshPlugin')\n        .use(require('@pmmmwh/react-refresh-webpack-plugin'))\n    } else if (framework === 'preact') {\n      chain\n        .plugin('fastRefreshPlugin')\n        .use(require('@prefresh/webpack'))\n    }\n  }\n}\n","import { modifyMiniWebpackChain } from './webpack.mini'\nimport { modifyH5WebpackChain } from './webpack.h5'\n\nimport type { IPluginContext } from '@tarojs/service'\n\nexport type Frameworks = 'react' | 'preact' | 'nerv'\n\nexport default (ctx: IPluginContext) => {\n  const { framework } = ctx.initialConfig\n\n  if (framework !== 'react' && framework !== 'nerv' && framework !== 'preact') return\n\n  ctx.modifyWebpackChain(({ chain }) => {\n    // 通用\n    setAlias(framework, chain)\n    chain\n      .plugin('definePlugin')\n      .tap(args => {\n        const config = args[0]\n        config.__TARO_FRAMEWORK__ = `\"${framework}\"`\n        return args\n      })\n\n    if (process.env.TARO_ENV === 'h5') {\n      // H5\n      modifyH5WebpackChain(ctx, framework, chain)\n    } else {\n      // 小程序\n      modifyMiniWebpackChain(ctx, framework, chain)\n    }\n  })\n}\n\nfunction setAlias (framework: Frameworks, chain) {\n  const alias = chain.resolve.alias\n\n  switch (framework) {\n    case 'preact':\n      alias.set('react', 'preact/compat')\n      alias.set('react-dom/test-utils', 'preact/test-utils')\n      alias.set('react-dom', 'preact/compat')\n      alias.set('react/jsx-runtime', 'preact/jsx-runtime')\n      break\n    case 'nerv':\n      alias.set('react$', 'nervjs')\n      alias.set('react-dom$', 'nervjs')\n      break\n  }\n}\n"],"names":["acorn","walk","setAlias","setLoader"],"mappings":"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"}